<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2D2D2D" />
  
  <title>HMCLab :: &lt;no title&gt;</title>
  

  <link rel="icon" type="image/png" sizes="32x32" href="../../_static/img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../../_static/img/favicon-16x16.png">
        <link rel="index" title="Index"
              href="../../genindex.html"/>

  <link rel="stylesheet" href="../../_static/css/insegel.css"/>

  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
        URL_ROOT:'',
        VERSION:'archive/parallel-tempering-9-gf4060a9',
        LANGUAGE:'None',
        COLLAPSE_INDEX:false,
        FILE_SUFFIX:'.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
    };
  </script>
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/javascript" src="../../None"></script>

  <script src="https://email.tl.fortawesome.com/c/eJxNjUEOgyAQAF8jR7Kw6wIHDh7sP1Cw2mgxgmn6-3JsMqc5zEQfE8dkxOY1KKMUOI3ACFKRJpSW2AAp7ontYIaxI6i7XPJVwyeVfCQ550Os3jLrGSNOLgbdAy6s0PBk2TFNjEbsfq31LB0OnX407pJa5v2faRadwSW63mn5KuLyR9j2tgx3zecanl-55R_-jjPs"></script>

</head>

<body>
  <div id="insegel-container">
    <header>
      <div id="logo-container">
          
          <a href="../../index.html"><img src="../../_static/hmctom.png"></a>
          

      </div>
      <div id="project-container">
        <h1>HMCLab Documentation</h1>
      </div>
    </header>

    <div id="content-container">

      <div id="main-content-container">
        <div id="main-content-header">
          <h1>&lt;no title&gt;</h1>
        </div>
        <div id="main-content">
          
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>import hmc_tomography
import matplotlib.pyplot as plt
import numpy
from hmc_tomography.Distributions import SourceLocation
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>import psvWave


settings = psvWave.get_dictionary()

# Create a 10x10 km domain
settings[&quot;domain&quot;][&quot;nx_inner&quot;] = 500
settings[&quot;domain&quot;][&quot;nz_inner&quot;] = 500
settings[&quot;domain&quot;][&quot;dx&quot;] = 20
settings[&quot;domain&quot;][&quot;dz&quot;] = 20
settings[&quot;domain&quot;][&quot;dt&quot;] = 0.001
settings[&quot;domain&quot;][&quot;nt&quot;] = 10000

settings[&quot;sources&quot;][&quot;peak_frequency&quot;] = 10
settings[&quot;sources&quot;][&quot;n_shots&quot;] = 3
settings[&quot;sources&quot;][&quot;n_sources&quot;] = 3
settings[&quot;sources&quot;][&quot;moment_angles&quot;] = [48, 79, 12]
settings[&quot;sources&quot;][&quot;ix_sources&quot;] = [0, 200, 350]  # in grid index
settings[&quot;sources&quot;][&quot;iz_sources&quot;] = [200, 250, 375]  # in grid index
settings[&quot;sources&quot;][&quot;which_source_to_fire_in_which_shot&quot;] = [[0], [1], [2]]

settings[&quot;medium&quot;][&quot;scalar_vs&quot;] = 0
settings[&quot;receivers&quot;][&quot;ix_receivers&quot;] = [65, 100, 300, 420]
settings[&quot;receivers&quot;][&quot;iz_receivers&quot;] = [0, 0, 0, 0]

settings[&quot;inversion&quot;][&quot;snapshot_interval&quot;] = 1000

settings
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>receivers_x = (
    numpy.array(settings[&quot;receivers&quot;][&quot;ix_receivers&quot;])
    * numpy.array(settings[&quot;domain&quot;][&quot;dx&quot;])
    / 1000.0
)[None, :]
receivers_z = (
    numpy.array(settings[&quot;receivers&quot;][&quot;iz_receivers&quot;])
    * numpy.array(settings[&quot;domain&quot;][&quot;dz&quot;])
    / 1000.0
)[None, :]

sources_x = (
    numpy.array(settings[&quot;sources&quot;][&quot;ix_sources&quot;])
    * numpy.array(settings[&quot;domain&quot;][&quot;dx&quot;])
    / 1000.0
)[None, :]
sources_z = (
    numpy.array(settings[&quot;sources&quot;][&quot;iz_sources&quot;])
    * numpy.array(settings[&quot;domain&quot;][&quot;dz&quot;])
    / 1000.0
)[None, :]


numpy.save(&quot;bin/5/receivers_x.npy&quot;, receivers_x)
numpy.save(&quot;bin/5/receivers_z.npy&quot;, receivers_z)
numpy.save(&quot;bin/5/sources_x.npy&quot;, sources_x)
numpy.save(&quot;bin/5/sources_z.npy&quot;, sources_z)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>psvWave.write_dictionary(&quot;bin/5/fd_settings.ini&quot;, settings)
fdModel = psvWave.fdModel(&quot;bin/5/fd_settings.ini&quot;)

fdModel.plot_domain()

plt.gca().invert_yaxis()
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>from scipy.ndimage import gaussian_filter, gaussian_filter1d

vp, vs, rho = fdModel.get_parameter_fields()

vp = 2000 * numpy.ones_like(vp)
rho = 1500 * numpy.ones_like(rho)

numpy.random.seed(321321)
anomalies = gaussian_filter(numpy.random.randn(*vp.shape), sigma=4)
anomalies = 200 * anomalies / numpy.abs(anomalies).max()
vp = vp + anomalies

anomalies_2 = gaussian_filter(numpy.random.randn(*vp.shape), sigma=4)
anomalies_2 = 200 * anomalies_2 / numpy.abs(anomalies_2).max()
rho = rho - 0.5 * anomalies + 0.5 * anomalies_2

fdModel.set_parameter_fields(vp, vs, rho)

numpy.save(&quot;bin/5/vp.npy&quot;, vp)
numpy.save(&quot;bin/5/vs.npy&quot;, vs)
numpy.save(&quot;bin/5/rho.npy&quot;, rho)

axes = fdModel.plot_fields(
    vmax=[vp.mean() * 1.2, vs.mean() * 1.2, rho.mean() * 1.2],
    vmin=[vp.mean() * 0.8, vs.mean() * 0.8, rho.mean() * 0.8],
)
for axis in axes:
    axis.invert_yaxis()
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span># Create &#39;true&#39; data
# print(&quot;Faking observed data&quot;)
for i_shot in range(fdModel.n_shots):
    fdModel.forward_simulate(i_shot, omp_threads_override=6)

# Cheating of course, as this is synthetically generated data.
ux_obs, uz_obs = fdModel.get_synthetic_data()

numpy.save(&quot;bin/5/ux_obs.npy&quot;, ux_obs)
numpy.save(&quot;bin/5/uz_obs.npy&quot;, uz_obs)

_ = fdModel.plot_data(data=(ux_obs, uz_obs), exagerration=1)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>ux_obs = numpy.load(&quot;bin/5/ux_obs.npy&quot;)
uz_obs = numpy.load(&quot;bin/5/uz_obs.npy&quot;)

numpy.random.seed(32312)

ux_obs_noise_addded = ux_obs + 3e-4 * gaussian_filter1d(
    numpy.random.randn(*ux_obs.shape), sigma=2, axis=2
)
uz_obs_noise_addded = uz_obs + 3e-4 * gaussian_filter1d(
    numpy.random.randn(*ux_obs.shape), sigma=2, axis=2
)

_ = fdModel.plot_data(data=(ux_obs_noise_addded, uz_obs_noise_addded), exagerration=1)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>time_step = 3
plt.figure()

particle_velocity = [None, None, None]
particle_velocity_max = [None, None, None]
for i_shot in range(fdModel.n_shots):
    particle_velocity[i_shot] = (
        fdModel.get_snapshots()[0][i_shot, time_step, :, :].T ** 2
        + fdModel.get_snapshots()[1][i_shot, time_step, :, :].T ** 2
    )
    particle_velocity_max[i_shot] = numpy.max(numpy.abs(particle_velocity[i_shot]))

field_extr = numpy.max(particle_velocity_max)

for i_shot in range(fdModel.n_shots):

    field = particle_velocity[i_shot]

    fdModel.plot_domain(axis=plt.gca())

    extent = fdModel.get_extent(True)
    plt.imshow(
        field,
        vmin=-field_extr,
        vmax=field_extr,
        cmap=plt.get_cmap(&quot;seismic&quot;),
        extent=[
            extent[0],
            extent[1],
            extent[3],
            extent[2],
        ],
    )

    cbar = plt.colorbar()
    cbar.set_label(&quot;particle velocity&quot;, rotation=90)

    plt.gca().invert_yaxis()
    plt.title(
        f&quot;Shot {i_shot+1}, time {time_step * settings[&#39;inversion&#39;][&#39;snapshot_interval&#39;] * settings[&#39;domain&#39;][&#39;dt&#39;]} seconds&quot;
    )
    plt.show()
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>velocity = ux_obs_noise_addded ** 2 + uz_obs_noise_addded ** 2

exceed_noise = numpy.empty_like(velocity)

for i_shot in range(fdModel.n_shots):
    plt.figure(figsize=(16, 8))
    noise_level = velocity[i_shot, :, 0:150].max()
    for i_rec in range(ux_obs_noise_addded.shape[1]):
        plt.plot(
            numpy.linspace(0, fdModel.dt * fdModel.nt, fdModel.nt),
            velocity[i_shot, i_rec, :],
        )
    plt.ylim([0, noise_level * 5])
    plt.xlim([2, 5.5])

    exceed_noise[i_shot, :, :] = velocity[i_shot, :, :] &gt; 5 * noise_level
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>for i_shot in range(fdModel.n_shots):
    plt.figure()
    plt.plot(exceed_noise[i_shot, :, :].T)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>arrival_times = numpy.empty((fdModel.n_shots, ux_obs_noise_addded.shape[1]))

for i_shot in range(fdModel.n_shots):
    for i_rec in range(ux_obs_noise_addded.shape[1]):
        arrival_times[i_shot, i_rec] = (
            fdModel.dt * numpy.where(exceed_noise[i_shot, i_rec, :])[0][0] + 0.05
        )

numpy.save(&quot;bin/5/arrival_times.npy&quot;, arrival_times)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>arrival_times = numpy.load(&quot;bin/5/arrival_times.npy&quot;)

receivers_x = numpy.load(&quot;bin/5/receivers_x.npy&quot;)
receivers_z = numpy.load(&quot;bin/5/receivers_z.npy&quot;)
sources_x = numpy.load(&quot;bin/5/sources_x.npy&quot;)
sources_z = numpy.load(&quot;bin/5/sources_z.npy&quot;)

arrival_times
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>likelihood = SourceLocation(
    receivers_x, receivers_z, arrival_times, numpy.ones_like(arrival_times) * 0.1
)
likelihood.describe()
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>likelihood.plot_data()
plt.legend()
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>from hmc_tomography.Distributions import (
    Normal,
    Uniform,
    CompositeDistribution,
    BayesRule,
)

event_1_x_prior = Normal(0, 5)
event_2_x_prior = Normal(4, 5)
event_3_x_prior = Normal(6, 5)

max_speed = 5  # km/s

# This is the time at any station, some wave is observed, meaning that origin time has to be before this.
latest_first_arrival = 4  # sec

event_1_z_prior = Uniform([0], [latest_first_arrival * max_speed])
event_2_z_prior = event_1_z_prior
event_3_z_prior = event_1_z_prior
event_1_t_prior = Uniform([-1], [latest_first_arrival])
event_2_t_prior = event_1_t_prior
event_3_t_prior = event_1_t_prior

speed_prior = Normal(2.0, 1.0 ** 2, lower_bounds=[0.5], upper_bounds=[max_speed])

prior = CompositeDistribution(
    [
        event_1_x_prior,
        event_1_z_prior,
        event_1_t_prior,
        event_2_x_prior,
        event_2_z_prior,
        event_2_t_prior,
        event_3_x_prior,
        event_3_z_prior,
        event_3_t_prior,
        speed_prior,
    ]
)

posterior = BayesRule([prior, likelihood])
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>from hmc_tomography.Samplers import HMC, RWMH

rwmh = RWMH()

rwmh.sample(
    &quot;bin/5/rwmh_trial.h5&quot;,
    posterior,
    initial_model=numpy.array([2, 2, 2, 2, 2, 2, 2, 2, 2, 2])[:, None],
    autotuning=True,
    proposals=100000,
    online_thinning=1,
    overwrite_existing_file=True,
    max_time=3,
)

hmc = HMC()

hmc.sample(
    &quot;bin/5/hmc_trial.h5&quot;,
    posterior,
    initial_model=numpy.array([2, 2, 2, 2, 2, 2, 2, 2, 2, 2])[:, None],
    autotuning=True,
    proposals=100000,
    online_thinning=1,
    overwrite_existing_file=True,
    max_time=3,
)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>with hmc_tomography.Samples(&quot;bin/5/rwmh_trial.h5&quot;, burn_in=0) as samples_no_burn:
    line_rwmh = plt.plot(
        numpy.linspace(0, 1, samples_no_burn[0, :].size),
        samples_no_burn[7:-1, :].T,
        &quot;r&quot;,
    )

with hmc_tomography.Samples(&quot;bin/5/hmc_trial.h5&quot;, burn_in=0) as samples_no_burn:
    line_hmc = plt.plot(
        numpy.linspace(0, 1, samples_no_burn[0, :].size),
        samples_no_burn[7:-1, :].T,
        &quot;k&quot;,
    )

plt.xlabel(&quot;fraction of short chain&quot;)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>hmc = HMC()

hmc.sample(
    &quot;bin/5/hmc_5_minutes.h5&quot;,
    posterior,
    initial_model=numpy.array([2, 2, 2, 2, 2, 2, 2, 2, 2, 2])[:, None],
    autotuning=True,
    proposals=200000,
    online_thinning=10,
    overwrite_existing_file=True,
    max_time=10,
)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>with hmc_tomography.Samples(&quot;bin/5/hmc_5_minutes.h5&quot;, burn_in=0) as samples:
    plt.plot(samples[-1, :100])
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>with hmc_tomography.Samples(&quot;bin/5/hmc_5_minutes.h5&quot;, burn_in=20) as samples:
    samples_n = samples.numpy

hmc_tomography.Visualization.marginal_grid(samples_n, [0, 1, 2, 9])
hmc_tomography.Visualization.marginal_grid(samples_n, [3, 4, 5, 9])
hmc_tomography.Visualization.marginal_grid(samples_n, [6, 7, 8, 9])
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>data_samples = 50

print(f&quot;We have {samples_n.shape[1]} samples, let&#39;s select {data_samples}.&quot;)

selection = numpy.random.randint(0, samples_n.shape[1], data_samples)

# We also discard the last dimension, misfit
selection = samples_n[:-1, selection]

from cycler import cycler

figure = plt.figure(figsize=(8, 8))
likelihood.plot_data(figure=figure)

cmap = plt.get_cmap(&quot;tab10&quot;)

for i in range(data_samples):

    data = likelihood.forward_vector(selection[:, i, None])

    for event in range(3):
        plt.scatter(
            likelihood.receiver_array_x.T,
            data[event, :],
            color=cmap(event),
            alpha=1.0 / 100,
        )

_ = plt.ylim([2, 5.2])
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>from matplotlib.colors import LinearSegmentedColormap

plt.figure(figsize=(10, 10))
for event in range(3):
    ncolors = 256
    color_array = plt.get_cmap(&quot;seismic&quot;)(range(ncolors))
    color_array[:, -1] = numpy.linspace(0.0, 0.5, ncolors)
    color_array[:, :-1] = cmap(event)[:-1]
    map_object = LinearSegmentedColormap.from_list(
        name=&quot;event_specific&quot;, colors=color_array
    )
    plt.register_cmap(cmap=map_object)

    plt.hist2d(
        samples_n[event * 3],
        samples_n[event * 3 + 1],
        range=[[-5, 15], [0, 10]],
        bins=50,
        cmap=&quot;event_specific&quot;,
    )

plt.scatter(
    likelihood.receiver_array_x, likelihood.receiver_array_z, c=&quot;r&quot;, label=&quot;receivers&quot;
)

plt.gca().invert_yaxis()

for event in range(3):
    plt.scatter(
        sources_x[0, event],
        sources_z[0, event],
        color=cmap(event),
        s=100,
        label=f&quot;Event {event} true location&quot;,
    )

plt.legend()
# plt.xlim([likelihood.receiver_array_x.min(), likelihood.receiver_array_x.max()])
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>threshold_samples = samples_n[:, samples_n[-2, :] &lt; 2.1]

plt.figure(figsize=(10, 10))
for event in range(3):
    ncolors = 256
    color_array = plt.get_cmap(&quot;seismic&quot;)(range(ncolors))
    color_array[:, -1] = numpy.linspace(0.0, 0.5, ncolors)
    color_array[:, :-1] = cmap(event)[:-1]
    map_object = LinearSegmentedColormap.from_list(
        name=&quot;event_specific&quot;, colors=color_array
    )
    plt.register_cmap(cmap=map_object)

    plt.hist2d(
        threshold_samples[event * 3],
        threshold_samples[event * 3 + 1],
        range=[[-5, 15], [0, 10]],
        bins=50,
        cmap=&quot;event_specific&quot;,
    )

plt.scatter(
    likelihood.receiver_array_x, likelihood.receiver_array_z, c=&quot;r&quot;, label=&quot;receivers&quot;
)

plt.gca().invert_yaxis()

for event in range(3):
    plt.scatter(
        sources_x[0, event],
        sources_z[0, event],
        color=cmap(event),
        s=100,
        label=f&quot;Event {event} true location&quot;,
    )

plt.legend()
# plt.xlim([likelihood.receiver_array_x.min(), likelihood.receiver_array_x.max()])
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>chains = 6

# 3 samplers
samplers = [HMC() for i in range(chains)]

# 3 posteriors (that are not the same!)
posteriors = [posterior] * chains

# 3 separate sample files
filenames = [f&quot;bin/5/hmc_parallel_{i}.h5&quot; for i in range(chains)]


obj = (
    hmc_tomography.Samplers.ParallelSampleSMP()
    .sample(
        samplers,
        filenames,
        posteriors,
        overwrite_existing_files=True,
        proposals=20000,
        exchange=True,
        initial_model=numpy.array([2, 2, 2, 2, 2, 2, 2, 2, 2, 2])[:, None],
        kwargs={&quot;autotuning&quot;: True, &quot;max_time&quot;: 10, &quot;online_thinning&quot;: 10},
    )
    .print_results()
)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>samples_n = [None] * len(filenames)

for i_chain, filename in enumerate(filenames):
    with hmc_tomography.Samples(filename, burn_in=0) as samples:
        plt.plot(samples[-1, 20:100], alpha=0.5)

        samples_n[i_chain] = samples[:-1, 20:]

samples_combined = numpy.hstack(samples_n)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>from matplotlib.colors import LinearSegmentedColormap

plt.figure(figsize=(10, 10))
for event in range(3):
    ncolors = 256
    color_array = plt.get_cmap(&quot;seismic&quot;)(range(ncolors))
    color_array[:, -1] = numpy.linspace(0.0, 0.5, ncolors)
    color_array[:, :-1] = cmap(event)[:-1]
    map_object = LinearSegmentedColormap.from_list(
        name=&quot;event_specific&quot;, colors=color_array
    )
    plt.register_cmap(cmap=map_object)

    plt.hist2d(
        samples_combined[event * 3],
        samples_combined[event * 3 + 1],
        range=[[-5, 15], [0, 10]],
        bins=50,
        cmap=&quot;event_specific&quot;,
    )

plt.scatter(
    likelihood.receiver_array_x, likelihood.receiver_array_z, c=&quot;r&quot;, label=&quot;receivers&quot;
)

plt.gca().invert_yaxis()

for event in range(3):
    plt.scatter(
        sources_x[0, event],
        sources_z[0, event],
        color=cmap(event),
        s=100,
        label=f&quot;Event {event} true location&quot;,
    )

plt.legend()
# plt.xlim([likelihood.receiver_array_x.min(), likelihood.receiver_array_x.max()])
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>threshold_samples = samples_combined[:, samples_combined[-2, :] &lt; 2.1]

plt.figure(figsize=(10, 10))
for event in range(3):
    ncolors = 256
    color_array = plt.get_cmap(&quot;seismic&quot;)(range(ncolors))
    color_array[:, -1] = numpy.linspace(0.0, 0.5, ncolors)
    color_array[:, :-1] = cmap(event)[:-1]
    map_object = LinearSegmentedColormap.from_list(
        name=&quot;event_specific&quot;, colors=color_array
    )
    plt.register_cmap(cmap=map_object)

    plt.hist2d(
        threshold_samples[event * 3],
        threshold_samples[event * 3 + 1],
        range=[[-5, 15], [0, 10]],
        bins=50,
        cmap=&quot;event_specific&quot;,
    )

plt.scatter(
    likelihood.receiver_array_x, likelihood.receiver_array_z, c=&quot;r&quot;, label=&quot;receivers&quot;
)

plt.gca().invert_yaxis()

for event in range(3):
    plt.scatter(
        sources_x[0, event],
        sources_z[0, event],
        color=cmap(event),
        s=100,
        label=f&quot;Event {event} true location&quot;,
    )

plt.legend()
# plt.xlim([likelihood.receiver_array_x.min(), likelihood.receiver_array_x.max()])
</pre></div>
</div>
</div>


        </div>
      </div>

      <div id="side-menu-container">

        <div id="search" role="search">
        <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
            <input type="text" name="q" placeholder="Search..." />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>
</div>

        <div id="side-menu" role="navigation">

          
  
    
  
  
    <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">HMC Tomography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hmc.html">The Hamiltonian Monte Carlo algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../setup.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks.html">Notebooks: Examples and tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../py-modindex.html">Module index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Alphabetic index</a></li>
</ul>

  


        </div>

        

      </div>

    </div>

<footer>
    <div id="footer-info">
        <ul id="build-details">
            
                <li class="footer-element">
                    
                        <a href="../../_sources/notebooks/tutorials/5 - Source location in assumed homogeneous media.ipynb.txt" rel="nofollow"> source</a>
                    
                </li>
            

            

            
        </ul>
        <div id="credit">
            created with <a href="http://sphinx-doc.org/">Sphinx</a> and <a href="https://github.com/Autophagy/insegel">Insegel</a>

        </div>
    </div>

    <a id="menu-toggle" class="fa fa-bars" aria-hidden="true"></a>

    <script type="text/javascript">
      $("#menu-toggle").click(function() {
        $("#menu-toggle").toggleClass("toggled");
        $("#side-menu-container").slideToggle(300);
      });
    </script>

</footer> 

</div>

</body>
</html>