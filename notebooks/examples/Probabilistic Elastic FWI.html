<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Probabilistic Elastic FWI &mdash; HMCLab archive/parallel-tempering-33-g7bdeca4-dirty documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/autoclasstoc.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="API reference" href="../../api/index.html" />
    <link rel="prev" title="Source Location in 3D" href="Source%20Location%20in%203D.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> HMCLab
            <img src="../../_static/hmctom.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                archive/parallel-tempering-33-g7bdeca4-dirty
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">HMC Tomography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hmc.html">The Hamiltonian Monte Carlo algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../setup.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../notebooks.html">Notebooks: Examples and tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../tutorials/0%20-%20Getting%20started.html">Tutorial 0 - Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/1%20-%20Tuning%20Hamiltonian%20Monte%20Carlo.html">Tutorial 1 - Tuning Hamiltonian Monte Carlo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/2%20-%20Separate%20priors%20per%20dimension.html">Tutorial 2 - Separate priors per dimension</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/3%20-%20Creating%20your%20own%20inverse%20problem.html">Tutorial 3 - Creating your own inverse problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/4%20-%20Running%20parallel%20Markov%20chains.html">Tutorial 4 - Running parallel Markov chains</a></li>
<li class="toctree-l2"><a class="reference internal" href="Linear%20%28dense%29%20forward%20operator.html">Linear (dense) forward operator</a></li>
<li class="toctree-l2"><a class="reference internal" href="Linear%20%28sparse%29%20forward%20operator.html">Linear (sparse) forward operator</a></li>
<li class="toctree-l2"><a class="reference internal" href="Source%20Location%20in%203D.html">Source Location in 3D</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Probabilistic Elastic FWI</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../py-modindex.html">Module index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Alphabetic index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">HMCLab</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../notebooks.html">Notebooks: Examples and tutorials</a> &raquo;</li>
      <li>Probabilistic Elastic FWI</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/notebooks/examples/Probabilistic Elastic FWI.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Probabilistic-Elastic-FWI">
<h1>Probabilistic Elastic FWI<a class="headerlink" href="#Probabilistic-Elastic-FWI" title="Permalink to this headline"></a></h1>
<p>In this notebook we look at probabilistic elastic Full-Waveform Inversion. The example here is purposefully kept very small with only little data, to facilitate experimentation.</p>
<p>We will use the external package <code class="docutils literal notranslate"><span class="pre">psvWave</span></code>, which implements Virieux 1986’s staggered FD scheme for P-SV wave propagation. Gradients are calculated using the adjoint method.</p>
<p>Note that the ‘wheels’ for psvWave are only guaranteed to work for Linux, on Python 3.7.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">hmclab</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">psvWave</span>

<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">AxesGrid</span>
</pre></div>
</div>
</div>
<p>First we start by creating some synthetic data. psvWave provides a basic setting in which one can run experiments. Let’s load those settings and have a look at them:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fwi_settings</span> <span class="o">=</span> <span class="n">psvWave</span><span class="o">.</span><span class="n">fdModel</span><span class="o">.</span><span class="n">get_dictionary</span><span class="p">()</span>

<span class="n">fwi_settings</span><span class="p">[</span><span class="s2">&quot;domain&quot;</span><span class="p">][</span><span class="s2">&quot;nx_inner&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">fwi_settings</span><span class="p">[</span><span class="s2">&quot;domain&quot;</span><span class="p">][</span><span class="s2">&quot;nz_inner&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">fwi_settings</span><span class="p">[</span><span class="s2">&quot;domain&quot;</span><span class="p">][</span><span class="s2">&quot;nx_inner_boundary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">fwi_settings</span><span class="p">[</span><span class="s2">&quot;domain&quot;</span><span class="p">][</span><span class="s2">&quot;nz_inner_boundary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">fwi_settings</span><span class="p">[</span><span class="s2">&quot;boundary&quot;</span><span class="p">][</span><span class="s2">&quot;np_boundary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">fwi_settings</span><span class="p">[</span><span class="s2">&quot;sources&quot;</span><span class="p">][</span><span class="s2">&quot;ix_sources&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">18</span><span class="p">]</span>
<span class="n">fwi_settings</span><span class="p">[</span><span class="s2">&quot;sources&quot;</span><span class="p">][</span><span class="s2">&quot;iz_sources&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">fwi_settings</span><span class="p">[</span><span class="s2">&quot;receivers&quot;</span><span class="p">][</span><span class="s2">&quot;ix_receivers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">]</span>
<span class="n">fwi_settings</span><span class="p">[</span><span class="s2">&quot;receivers&quot;</span><span class="p">][</span><span class="s2">&quot;iz_receivers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">]</span>

<span class="n">fwi_settings</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;domain&#39;: {&#39;nt&#39;: 1000,
  &#39;nx_inner&#39;: 20,
  &#39;nz_inner&#39;: 20,
  &#39;nx_inner_boundary&#39;: 0,
  &#39;nz_inner_boundary&#39;: 0,
  &#39;dx&#39;: 1.249,
  &#39;dz&#39;: 1.249,
  &#39;dt&#39;: 0.0002},
 &#39;boundary&#39;: {&#39;np_boundary&#39;: 10, &#39;np_factor&#39;: 0.015},
 &#39;medium&#39;: {&#39;scalar_rho&#39;: 1500.0, &#39;scalar_vp&#39;: 2000.0, &#39;scalar_vs&#39;: 800.0},
 &#39;sources&#39;: {&#39;peak_frequency&#39;: 50.0,
  &#39;n_sources&#39;: 2,
  &#39;n_shots&#39;: 1,
  &#39;source_timeshift&#39;: 0.005,
  &#39;delay_cycles_per_shot&#39;: 24,
  &#39;moment_angles&#39;: [90, 180],
  &#39;ix_sources&#39;: [2, 18],
  &#39;iz_sources&#39;: [2, 2],
  &#39;which_source_to_fire_in_which_shot&#39;: [[0, 1]]},
 &#39;receivers&#39;: {&#39;nr&#39;: 4,
  &#39;ix_receivers&#39;: [4, 8, 12, 16],
  &#39;iz_receivers&#39;: [18, 18, 18, 18]},
 &#39;inversion&#39;: {&#39;snapshot_interval&#39;: 10},
 &#39;basis&#39;: {&#39;npx&#39;: 1, &#39;npz&#39;: 1},
 &#39;output&#39;: {&#39;observed_data_folder&#39;: &#39;.&#39;, &#39;stf_folder&#39;: &#39;.&#39;}}
</pre></div></div>
</div>
<p>We see that this simulation has two sources (moment tensors with Ricker wave STF’s) that are on the ‘bottom’ of the medium. These are recorded by sources at the top. The medium is surrounded by an absorbing boundary. Let’s compress the simulation a bit and shorten it by firing the sources close together:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fwi_settings</span><span class="p">[</span><span class="s2">&quot;domain&quot;</span><span class="p">][</span><span class="s2">&quot;nt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1400</span>
<span class="n">fwi_settings</span><span class="p">[</span><span class="s2">&quot;sources&quot;</span><span class="p">][</span><span class="s2">&quot;delay_cycles_per_shot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
</pre></div>
</div>
</div>
<p>Now we can create this simulation object with the requested settings:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">psvWave</span><span class="o">.</span><span class="n">fdModel</span><span class="o">.</span><span class="n">write_dictionary</span><span class="p">(</span><span class="s2">&quot;settings.ini&quot;</span><span class="p">,</span> <span class="n">fwi_settings</span><span class="p">)</span>

<span class="n">fdModel</span> <span class="o">=</span> <span class="n">psvWave</span><span class="o">.</span><span class="n">fdModel</span><span class="p">(</span><span class="s2">&quot;settings.ini&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Loading configuration file: &#39;settings.ini&#39;.
Parsing passed configuration.
</pre></div></div>
</div>
<p>We can plot the geometry of all shots by doing the following.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">i_shot</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fdModel</span><span class="o">.</span><span class="n">n_shots</span><span class="p">):</span>
    <span class="n">fdModel</span><span class="o">.</span><span class="n">plot_domain</span><span class="p">(</span><span class="n">shot_to_plot</span><span class="o">=</span><span class="n">i_shot</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shot </span><span class="si">{</span><span class="n">i_shot</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_examples_Probabilistic_Elastic_FWI_10_0.png" src="../../_images/notebooks_examples_Probabilistic_Elastic_FWI_10_0.png" />
</div>
</div>
<p>To look how HMC works in this settings, we need an interesting model to test on. We create a target model below, which contains a spherical anomaly in P-wave velocity, S-wave velocity and density:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Create target model</span>
<span class="c1"># Get the coordinates of every grid point</span>
<span class="n">IX</span><span class="p">,</span> <span class="n">IZ</span> <span class="o">=</span> <span class="n">fdModel</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># Get the associated parameter fields</span>
<span class="n">vp</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">rho</span> <span class="o">=</span> <span class="n">fdModel</span><span class="o">.</span><span class="n">get_parameter_fields</span><span class="p">()</span>

<span class="n">x_middle</span> <span class="o">=</span> <span class="p">(</span><span class="n">IX</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">IX</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span>
<span class="n">z_middle</span> <span class="o">=</span> <span class="p">(</span><span class="n">IZ</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">IZ</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span>

<span class="c1"># Add a circular negative anomaly to the &#39;true&#39; model</span>
<span class="n">circle</span> <span class="o">=</span> <span class="p">((</span><span class="n">IX</span> <span class="o">-</span> <span class="n">x_middle</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">IZ</span> <span class="o">-</span> <span class="n">z_middle</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">&lt;</span> <span class="mi">5</span>
<span class="n">vs</span> <span class="o">=</span> <span class="n">vs</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">circle</span><span class="p">)</span>
<span class="n">vp</span> <span class="o">=</span> <span class="n">vp</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">circle</span><span class="p">)</span>
<span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">circle</span><span class="p">)</span>

<span class="n">vp_target</span> <span class="o">=</span> <span class="n">vp</span>
<span class="n">vs_target</span> <span class="o">=</span> <span class="n">vs</span>
<span class="n">rho_target</span> <span class="o">=</span> <span class="n">rho</span>
</pre></div>
</div>
</div>
<p>Let’s visualize this anomaly in all parameters:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">background_means</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">1500</span><span class="p">])</span>
<span class="n">percentage_deviation</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">mins</span> <span class="o">=</span> <span class="n">background_means</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">percentage_deviation</span><span class="p">)</span>
<span class="n">maxs</span> <span class="o">=</span> <span class="n">background_means</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">percentage_deviation</span><span class="p">)</span>

<span class="n">fdModel</span><span class="o">.</span><span class="n">set_parameter_fields</span><span class="p">(</span><span class="n">vp_target</span><span class="p">,</span> <span class="n">vs_target</span><span class="p">,</span> <span class="n">rho_target</span><span class="p">)</span>
<span class="n">fdModel</span><span class="o">.</span><span class="n">plot_fields</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">mins</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">maxs</span><span class="p">)</span>
<span class="n">true_model</span> <span class="o">=</span> <span class="n">fdModel</span><span class="o">.</span><span class="n">get_model_vector</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_examples_Probabilistic_Elastic_FWI_14_0.png" src="../../_images/notebooks_examples_Probabilistic_Elastic_FWI_14_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">time</span> fdModel.forward_simulate(0, omp_threads_override=6)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 157 ms, sys: 13.9 ms, total: 171 ms
Wall time: 28.7 ms
</pre></div></div>
</div>
<p>Let’s create the ‘observed’ data with some noise:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Create &#39;true&#39; data</span>
<span class="c1"># print(&quot;Faking observed data&quot;)</span>
<span class="k">for</span> <span class="n">i_shot</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fdModel</span><span class="o">.</span><span class="n">n_shots</span><span class="p">):</span>
    <span class="n">fdModel</span><span class="o">.</span><span class="n">forward_simulate</span><span class="p">(</span><span class="n">i_shot</span><span class="p">,</span> <span class="n">omp_threads_override</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

<span class="c1"># Cheating of course, as this is synthetically generated data.</span>
<span class="n">ux_obs</span><span class="p">,</span> <span class="n">uz_obs</span> <span class="o">=</span> <span class="n">fdModel</span><span class="o">.</span><span class="n">get_synthetic_data</span><span class="p">()</span>

<span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">32312</span><span class="p">)</span>
<span class="n">ux_obs</span> <span class="o">+=</span> <span class="mi">25</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">ux_obs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">uz_obs</span> <span class="o">+=</span> <span class="mi">25</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">ux_obs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">fdModel</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="n">ux_obs</span><span class="p">,</span> <span class="n">uz_obs</span><span class="p">),</span> <span class="n">exagerration</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&lt;Figure size 576x216 with 2 Axes&gt;,
 array([[&lt;AxesSubplot:title={&#39;center&#39;:&#39;horizontal displacement shot 0&#39;}, xlabel=&#39;time [s]&#39;, ylabel=&#39;channel id&#39;&gt;,
         &lt;AxesSubplot:title={&#39;center&#39;:&#39;vertical displacement shot 0&#39;}, xlabel=&#39;time [s]&#39;, ylabel=&#39;channel id&#39;&gt;]],
       dtype=object))
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_examples_Probabilistic_Elastic_FWI_17_1.png" src="../../_images/notebooks_examples_Probabilistic_Elastic_FWI_17_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ux_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x7f1b88a3bd90&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_examples_Probabilistic_Elastic_FWI_18_1.png" src="../../_images/notebooks_examples_Probabilistic_Elastic_FWI_18_1.png" />
</div>
</div>
<p>To get some intuition on what we are actually doing, we can plot the wavefield in the one shot at two different points in time. This is the wavefield of the ‘true’ data.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">time_step</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i_shot</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fdModel</span><span class="o">.</span><span class="n">n_shots</span><span class="p">):</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">fdModel</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="n">i_shot</span><span class="p">,</span> <span class="n">time_step</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">field_extr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
        <span class="n">vmin</span><span class="o">=-</span><span class="n">field_extr</span><span class="p">,</span>
        <span class="n">vmax</span><span class="o">=</span><span class="n">field_extr</span><span class="p">,</span>
        <span class="n">extent</span><span class="o">=</span><span class="n">fdModel</span><span class="o">.</span><span class="n">get_extent</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;seismic&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shot </span><span class="si">{</span><span class="n">i_shot</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">, step 80&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">time_step</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i_shot</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fdModel</span><span class="o">.</span><span class="n">n_shots</span><span class="p">):</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">fdModel</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="n">i_shot</span><span class="p">,</span> <span class="n">time_step</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">field_extr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
        <span class="n">vmin</span><span class="o">=-</span><span class="n">field_extr</span><span class="p">,</span>
        <span class="n">vmax</span><span class="o">=</span><span class="n">field_extr</span><span class="p">,</span>
        <span class="n">extent</span><span class="o">=</span><span class="n">fdModel</span><span class="o">.</span><span class="n">get_extent</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;seismic&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shot </span><span class="si">{</span><span class="n">i_shot</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">, step 95&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_examples_Probabilistic_Elastic_FWI_20_0.png" src="../../_images/notebooks_examples_Probabilistic_Elastic_FWI_20_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_examples_Probabilistic_Elastic_FWI_20_1.png" src="../../_images/notebooks_examples_Probabilistic_Elastic_FWI_20_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># sampler = hmclab.Samplers.HMC()</span>

<span class="c1"># posterior = hmclab.Distributions.ElasticFullWaveform2D(</span>
<span class="c1">#     &quot;settings.ini&quot;,</span>
<span class="c1">#     ux_obs=ux_obs,</span>
<span class="c1">#     uz_obs=uz_obs,</span>
<span class="c1">#     omp_threads_override=6,</span>
<span class="c1">#     temperature=5**2,</span>
<span class="c1"># )</span>

<span class="c1"># posterior.update_bounds(</span>
<span class="c1">#     posterior.get_model_vector() - 200,</span>
<span class="c1">#     posterior.get_model_vector() + 200,</span>
<span class="c1"># )</span>

<span class="c1"># %rm samples.h5</span>

<span class="c1"># sampler.sample(</span>
<span class="c1">#     &quot;samples.h5&quot;,</span>
<span class="c1">#     posterior,</span>
<span class="c1">#     autotuning=True,</span>
<span class="c1">#     initial_model=true_model[:,None],</span>
<span class="c1">#     amount_of_steps=10,</span>
<span class="c1">#     proposals=10000,</span>
<span class="c1">#     overwrite_existing_file=False,</span>
<span class="c1"># )</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Execute parallel sampling</span>
<span class="n">parallel_sampler</span> <span class="o">=</span> <span class="n">hmclab</span><span class="o">.</span><span class="n">Samplers</span><span class="o">.</span><span class="n">ParallelSampleSMP</span><span class="p">()</span>

<span class="n">samplers</span> <span class="o">=</span> <span class="p">[</span><span class="n">hmclab</span><span class="o">.</span><span class="n">Samplers</span><span class="o">.</span><span class="n">HMC</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>

<span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;samples_fwi_parallel_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.h5&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>

<span class="n">temperatures</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

<span class="n">posteriors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">hmclab</span><span class="o">.</span><span class="n">Distributions</span><span class="o">.</span><span class="n">ElasticFullWaveform2D</span><span class="p">(</span>
        <span class="s2">&quot;settings.ini&quot;</span><span class="p">,</span>
        <span class="n">ux_obs</span><span class="o">=</span><span class="n">ux_obs</span><span class="p">,</span>
        <span class="n">uz_obs</span><span class="o">=</span><span class="n">uz_obs</span><span class="p">,</span>
        <span class="n">omp_threads_override</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">temperature</span><span class="o">=</span><span class="p">(</span><span class="mf">5.0</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">temp</span> <span class="ow">in</span> <span class="n">temperatures</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">posterior</span> <span class="ow">in</span> <span class="n">posteriors</span><span class="p">:</span>
    <span class="n">posterior</span><span class="o">.</span><span class="n">update_bounds</span><span class="p">(</span>
        <span class="n">posterior</span><span class="o">.</span><span class="n">get_model_vector</span><span class="p">()</span> <span class="o">-</span> <span class="mi">200</span><span class="p">,</span>
        <span class="n">posterior</span><span class="o">.</span><span class="n">get_model_vector</span><span class="p">()</span> <span class="o">+</span> <span class="mi">200</span><span class="p">,</span>
    <span class="p">)</span>

<span class="n">initial_model</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">true_model</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span>
    <span class="n">true_model</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span>
<span class="p">]</span>

<span class="n">parallel_sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
    <span class="n">samplers</span><span class="p">,</span>
    <span class="n">filenames</span><span class="p">,</span>
    <span class="n">posteriors</span><span class="p">,</span>
    <span class="n">proposals</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">overwrite_existing_files</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">initial_model</span><span class="o">=</span><span class="n">true_model</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Loading configuration file: &#39;settings.ini&#39;.
Parsing passed configuration.
Loading configuration file: &#39;settings.ini&#39;.
Parsing passed configuration.
Starting 2 markov chains...
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
sys:1: Warning:
Silently overwriting samples file (samples_fwi_parallel_0.h5) if it exists.
sys:1: Warning:
Silently overwriting samples file (samples_fwi_parallel_1.h5) if it exists.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
enter
enter
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "b6db81a06524464c880c70b290cf7035", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<!-- empty output --></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">posteriors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_model_vector</span><span class="p">(</span><span class="n">posteriors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_model_vector</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parallel_sampler</span><span class="o">.</span><span class="n">samplers</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">stepsizes</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">/tmp/ipykernel_23267/3789021934.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>plt<span class="ansi-blue-fg">.</span>plot<span class="ansi-blue-fg">(</span>sampler<span class="ansi-blue-fg">.</span>stepsizes<span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">NameError</span>: name &#39;sampler&#39; is not defined
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">with</span> <span class="n">hmclab</span><span class="o">.</span><span class="n">Samples</span><span class="p">(</span><span class="s2">&quot;samples.h5&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">samples</span><span class="p">:</span>
    <span class="n">samples_n</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">numpy</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">fdModel</span><span class="o">.</span><span class="n">plot_model_vector</span><span class="p">(</span><span class="n">samples_n</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">100</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">mins</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">maxs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fdModel</span><span class="o">.</span><span class="n">plot_model_vector</span><span class="p">(</span>
    <span class="c1">#     posterior.blob.forward_transform_background(</span>
    <span class="n">samples_n</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">],</span>
    <span class="n">vmin</span><span class="o">=</span><span class="n">mins</span><span class="p">,</span>
    <span class="n">vmax</span><span class="o">=</span><span class="n">maxs</span>
    <span class="c1">#     )</span>
<span class="p">)</span>

<span class="n">fdModel</span><span class="o">.</span><span class="n">plot_model_vector</span><span class="p">(</span>
    <span class="c1">#     posterior.blob.forward_transform_background(</span>
    <span class="n">samples_n</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="c1">#     )</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">samples_n</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">samples_n</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">m</span> <span class="o">=</span> <span class="n">samples_n</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mf</span> <span class="o">=</span> <span class="n">m</span>  <span class="c1"># posterior.blob.forward_transform_background(m[:,None])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">vector_splits</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">fields</span> <span class="o">=</span> <span class="n">fdModel</span><span class="o">.</span><span class="n">get_parameter_fields</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
    <span class="n">field</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">field</span><span class="p">[</span>
        <span class="p">(</span><span class="n">fdModel</span><span class="o">.</span><span class="n">nx_inner_boundary</span> <span class="o">+</span> <span class="n">fdModel</span><span class="o">.</span><span class="n">np_boundary</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="p">(</span>
            <span class="n">fdModel</span><span class="o">.</span><span class="n">nx_inner_boundary</span> <span class="o">+</span> <span class="n">fdModel</span><span class="o">.</span><span class="n">np_boundary</span>
        <span class="p">),</span>
        <span class="p">(</span><span class="n">fdModel</span><span class="o">.</span><span class="n">nz_inner_boundary</span> <span class="o">+</span> <span class="n">fdModel</span><span class="o">.</span><span class="n">np_boundary</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="p">(</span>
            <span class="n">fdModel</span><span class="o">.</span><span class="n">nz_inner_boundary</span> <span class="o">+</span> <span class="n">fdModel</span><span class="o">.</span><span class="n">np_boundary</span>
        <span class="p">),</span>
    <span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">vector_splits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">fdModel</span><span class="o">.</span><span class="n">nz_free_parameters</span><span class="p">,</span>
                <span class="n">fdModel</span><span class="o">.</span><span class="n">nx_free_parameters</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">T</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">gaussian_filter</span>

<span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
    <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">10</span><span class="p">:</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span><span class="o">-</span><span class="mi">10</span><span class="p">],</span> <span class="n">sigma</span><span class="p">),</span>
    <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;seismic&quot;</span><span class="p">),</span>
    <span class="n">vmin</span><span class="o">=</span><span class="mi">1800</span><span class="p">,</span>
    <span class="n">vmax</span><span class="o">=</span><span class="mi">2200</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
    <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">10</span><span class="p">:</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span><span class="o">-</span><span class="mi">10</span><span class="p">],</span> <span class="n">sigma</span><span class="p">),</span>
    <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;seismic&quot;</span><span class="p">),</span>
    <span class="n">vmin</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
    <span class="n">vmax</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
    <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">10</span><span class="p">:</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span><span class="o">-</span><span class="mi">10</span><span class="p">],</span> <span class="n">sigma</span><span class="p">),</span>
    <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;seismic&quot;</span><span class="p">),</span>
    <span class="n">vmin</span><span class="o">=</span><span class="mi">1350</span><span class="p">,</span>
    <span class="n">vmax</span><span class="o">=</span><span class="mi">1650</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">samples_n</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>

<span class="c1"># C= np.cov(samples_n[:-1, :])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">40</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;seismic&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">250</span><span class="p">,</span> <span class="p">:</span><span class="mi">400</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;seismic&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">samples_n</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">samples_n</span><span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="p">:],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Source%20Location%20in%203D.html" class="btn btn-neutral float-left" title="Source Location in 3D" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../api/index.html" class="btn btn-neutral float-right" title="API reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2021, Andrea Zunino, Andreas Fichtner, Lars Gebraad.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>